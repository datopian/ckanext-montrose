{% extends "page.html" %}

{% block styles %}
    {% resource 'montrose/main' %}
    {% resource 'montrose/map' %}
    {% resource 'montrose/vendor/jquery-1_12_3.js' %}
    {% resource 'montrose/vendor/js.cookie.js' %}
    {% resource 'montrose/dashboard.js' %}
    {% resource 'montrose/font-awesome.css' %}
    {% resource 'montrose/vendor/jquery.popupoverlay.js' %}
{% endblock %}

{% if country.montrose_dashboard_base_color %}
  {% set base_color = "#" + country.montrose_dashboard_base_color %}
{% else %}
  {% set base_color = "#000000" %}
{% endif %}

{% if country.montrose_dashboard_secondary_color %}
  {% set secondary_color = "#" + country.montrose_dashboard_secondary_color %}
{% else %}
  {% set secondary_color = "#000000" %}
{% endif %}

{% if country.montrose_main_color %}
  {% set font_base_color = "#" + country.montrose_main_color %}
{% else %}
  {% set font_base_color = "#818181" %}
{% endif %}

{% if country.montrose_new_data_color %}
  {% set font_new_data_color = "#" + country.montrose_new_data_color %}
{% else %}
  {% set font_new_data_color = "#000000" %}
{% endif %}

{% if country.montrose_all_data_color %}
  {% set font_all_data_color = "#" + country.montrose_all_data_color %}
{% else %}
  {% set font_all_data_color = "#000000" %}
{% endif %}

{% if country.montrose_map %}
    {% set montrose_maps = h.montrose_convert_to_list(country.montrose_map) %}
    {% set montrose_geoJsonUrlList = [] %}}
    {% for montrose_map in montrose_maps %}
        {#                Apparently we can append only in an if statement#}
        {% if montrose_geoJsonUrlList.append(h.montrose_get_resource_url(montrose_map)) %}
        {% endif %}
    {% endfor %}
{% else %}
    {% set montrose_maps = [] %}
    {% set montrose_geoJsonUrlList = [] %}
{% endif %}

{% if country.montrose_map_main_property %}
    {% set montrose_map_main_properties = h.montrose_convert_to_list(country.montrose_map_main_property) %}
{% endif %}


{% if montrose_maps %}
{% set montrose_resource_names = h.montrose_get_resource_names_from_ids(montrose_maps) %}
{% endif %}


{#  set base_color = "#" + country.montrose_dashboard_base_color #}
{# set secondary_color = "#" + country.montrose_dashboard_secondary_color #}
{# set font_base_color = "#" + country.montrose_main_color #}
{# set font_new_data_color = "#" + country.montrose_new_data_color #}
{# set font_all_data_color = "#" + country.montrose_all_data_color #}


{% block page %}
    <div class="boxed-layout">
    <header>
        <div class="container">
            <div class="row">
                <div class="col-sm-5 col-md-3 country-logo">
                    <a href="#"><img class="img-responsive" src="{{ country.image_display_url }}" height="130"
                                     alt="USEDATA logo"></a>
                </div>
                <div class="col-sm-5 col-md-3">
                  <h1 class="">{{ country.montrose_country_header }}</h1>
                </div>

              {% if country.montrose_lang_is_active == '1'%}
                {% if country.montrose_secondary_language == 'en' %}
                  {% set country_name = country.montrose_secondary_dashboard %}
                {% else  %}
                  {% set country_name = c.name %}
                {% endif %}
                <div class="col-sm-2 col-md-2 language-selector">
                    <ul class="list-inline">
                        <li>
                            <img class="language-flag" src="/img/uk-flag-23x17.png" height="17" alt="UK flag">
                            <a href="{{ h.url_for(controller='ckanext.montrose.controllers.dashboard:DashboardsController', action='montrose_country_dashboard', name=country_name, locale='en') }}" class="language-picker-link">
                                <span class="language-name">En</span>
                            </a>
                        </li>
                        {% if country.montrose_secondary_dashboard and country.montrose_secondary_dashboard != 'none' and country.montrose_secondary_language and country.montrose_secondary_language != 'none' %}
                          {% if country.montrose_secondary_language == 'my_MM' %}
                            {% set flag_url = '/img/myanmar-flag-60x40.png' %}
                            {% set country_short_name = 'Mya' %}
                            {% set locale = 'my_MM' %}
                            {% set country_name = country.montrose_secondary_dashboard %}
                          {% elif country.montrose_secondary_language == 'sw' %}
                            {% set flag_url = '/img/tanzania_flag.jpg' %}
                            {% set country_short_name = 'Sw' %}
                            {% set locale = 'sw' %}
                            {% set country_name = country.montrose_secondary_dashboard %}
                          {% else %}
                            {% set locale = request.environ.get('CKAN_LANG') %}

                            {% if locale == 'my_MM' %}
                              {% set flag_url = '/img/myanmar-flag-60x40.png' %}
                              {% set country_short_name = 'Mya' %}
                            {% elif locale == 'sw' %}
                              {% set flag_url = '/img/tanzania_flag.jpg' %}
                              {% set country_short_name = 'Sw' %}
                            {% endif %}

                            {% if country.montrose_secondary_language == 'en' %}
                              {% set country_name = c.name %}
                            {% else  %}
                              {% set country_name = country.montrose_secondary_dashboard %}
                            {% endif %}
                          {% endif %}
                          <li>
                              <img class="language-flag" src="{{ flag_url }}" width="21" alt="{{ country_short_name | upper }} flag">
                              <a href="{{ h.url_for(controller='ckanext.montrose.controllers.dashboard:DashboardsController', action='montrose_country_dashboard', name=country_name, locale=locale) }}" class="language-picker-link">
                                  <span class="language-name">{{ country_short_name }}</span>
                              </a>
                          </li>
                        {% endif %}
                    </ul>
                </div>
              {% endif %}

    <nav class="top-navigation pull-right" style="background-color: {{ base_color }}">
        <div class="">
            <ul class="list-inline">
                <li><a href="http://www.usedata.info/about-2/">{{ _('About') }}</a></li>
                <li><a href="http://www.usedata.info/help/">{{ _('Help') }}</a></li>
                <li><a href="http://www.usedata.info/resources/">{{ _('Resources') }}</a></li>
                <li><a href="http://www.usedata.info/contact/">{{ _('Contact') }}</a></li>
            </ul>
        </div>
    </nav>


            </div>
        </div>
    </header>
    <!--
    <nav class="main-navigation" style="background-color: {{ base_color }}">
        <div class="container">
            <ul class="list-inline">
                <li><a href="#">About</a></li>
                <li><a href="#">Help</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </div>
    </nav>
    -->
    <div class="container">

    <div class="hero-map-wrap">
      <div class="hero-controls">
          <div class="hero-block hero-info-select hidden" id="map-info">
              <div class="hero-select" style="border: 5px solid {{ base_color }}">
                  <select id="montrose_resource" class="form-control" style="color: {{ base_color }};">
                  {% for montrose_map in montrose_maps %}
                    <option
                        value="{{ montrose_geoJsonUrlList[loop.index0] }}">{{ montrose_resource_names[loop.index0] }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="hero-select" style="border: 5px solid {{ base_color }}">
                  <select id="dataset" class="form-control" style="color: {{ base_color }};"></select>
              </div>
          </div>
      </div>

      <div
              data-module="montrose_map"
              data-module-id="hero_map"
              {% if montrose_geoJsonUrlList|length > 0 %}
                data-module-mapurl="{{ montrose_geoJsonUrlList|join(',') }}"
              {% else %}
                data-module-mapurl="[]"
              {% endif %}
              data-module-countryname="{{ country.display_name }}"
              data-module-color="{{ base_color }}"
              data-module-main_property="{{ montrose_map_main_properties|join(',') }}"
              id="hero_map"
      >
          <div class="media hero-info">
            <div class="media-left">
                <img id="map-info-img" class="language-flag" src="/images/usedata-info-icon.svg" width="41" alt="icon">
            </div>
            <div class="media-body hidden">{{ _('All efforts have been made to make this map accurate. However, USEDATA and its
                Service Providers accept no liability for any errors, omissions, or inaccuracies in the information
                provided on this map.') }} © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> {{ _('contributors') }}
            </div>
        </div>
      </div>

    </div>
        <div class="description-short">
            <p class="dashboard-description">{{ h.montrose_smart_truncate(country.montrose_country_description) }}{% if country.montrose_country_description|length > 800 %}..
                    <a href="#" class="more-link">Read more</a>
                {% endif %}
            </p>
        </div>
        <div class="description-full hidden">
            <p class="dashboard-description">{{ country.montrose_country_description }}
                <a href="#" class="more-link">Read less</a></p>
        </div>
    </div>
    {% if country.montrose_survey_enabled == '1' %}
        <div id="survey_popup">
            <h4>Survey</h4>
            <hr>
            <p class="survey_text">{{ country.montrose_survey_text }}</p>
            <button id="survey_popup_close" class="btn btn-default">Close</button>
            <a href="{{ country.montrose_survey_link }}" class="survey_link btn btn-success" target="_blank">Go to survey</a>
        </div>
    {% endif %}

    <main class="container">
        <div class="graphs">
          <div class="row">
            {% if country.montrose_chart_1 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_1,
                    subheader=country.montrose_chart_1_subheader
                %}
            {% endif %}
            {% if country.montrose_chart_2 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_2,
                    subheader=country.montrose_chart_2_subheader
                %}
            {% endif %}
            {% if country.montrose_chart_3 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_3,
                    subheader=country.montrose_chart_3_subheader
                %}
            {% endif %}
              </div>
          <div class="row">
            {% if country.montrose_chart_4 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_4,
                    subheader=country.montrose_chart_4_subheader
                %}
            {% endif %}
            {% if country.montrose_chart_5 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_5,
                    subheader=country.montrose_chart_5_subheader
                %}
            {% endif %}
            {% if country.montrose_chart_6 %}
                {% snippet 'dashboards/snippets/show_charts.html',
                    resource_view_id=country.montrose_chart_6,
                    subheader=country.montrose_chart_6_subheader
                %}
            {% endif %}
          </div>
        </div>
        <div class="new-data">
            <h2 class="data-block-heading" style="color: {{ font_base_color }}">{{ _('Newly Released Data') }}
            <a id="newly-released-data-btn" type="button">
              <i class="fa fa-expand pull-right"></i>
            </a>
            </h2>
            <div
                id="newly-released-data"
                class="hidden"
                style="border-top: 3px solid {{ base_color }};
                       border-bottom: 3px solid {{ base_color }}">
                {{ h.snippet('dashboards/snippets/show_datasets.html',
                              packages=h.montrose_get_newly_released_data(),
                              datasets_group_name='newdata',
                              color=font_new_data_color) }}
            </div>
        </div>

        <div class="all-data" id="search-data">
            {% set facets = {
          'fields': c.fields_grouped,
          'search': c.search_facets,
          'titles': [{"value": "groups", "name": _('Themes')},
                     {"value": "tags", "name": _('Tags')},
                     {"value": "res_format", "name": _('Resource Format')},
                     {"value": "license_id", "name": _('Licenses')},
                     {"value": "author", "name": _('Authors')},],
          'translated_fields': c.translated_fields,
          'remove_field': c.remove_field } %}
            {% set sorting = [
          (_('Relevance'), 'score desc, metadata_modified desc'),
          (_('Name Ascending'), 'title_string asc'),
          (_('Name Descending'), 'title_string desc'),
          (_('Last Modified'), 'metadata_modified desc'),
          (_('Popular'), 'views_recent desc') if g.tracking_enabled else (false, false) ] %}
            {% snippet 'dashboards/snippets/search_form.html', form_id='dataset-search-form',
                                                           type='dataset',
                                                           query=c.q,
                                                           sorting=sorting,
                                                           sorting_selected=c.sort_by_selected,
                                                           count=c.page.item_count,
                                                           facets=facets,
                                                           show_empty=request.params,
                                                           error=c.query_error,
                                                           fields=c.fields,
                                                           font_base_color=font_base_color,
                                                           base_color=base_color,
                                                           secondary_color=secondary_color %}
            <div class="data-block-header">
                <div class="row">
                    <div class="col-md-2">
                        <h3 class="data-block-heading" style="color: {{ font_base_color }}">{{ _('Filter Data by') }}:</h3>
                    </div>
                    {% for facet in facets.titles %}
                        {{ h.snippet('dashboards/snippets/facet_list.html', name=facet, country_name=country.name) }}
                    {% endfor %}
                </div>
            </div>
            <div class="data-block">
                {{ h.snippet('dashboards/snippets/show_datasets.html',
                                                                      packages=c.page.items,
                                                                      datasets_group_name='search',
                                                                      color=font_all_data_color) }}
            </div>
        </div>
          {{h.snippet('dashboards/snippets/pagination.html', current=c.page.page, per_page=c.page.items_per_page, total=c.page.item_count)}}
    </main>
    </div>
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-2 col-lg-4">
                    <ul class="list-unstyled list-footer-nav">
                        <li><a href="http://www.usedata.info/about-2/">{{ _('About') }}</a></li>
                        <li><a href="http://www.usedata.info/help/">{{ _('Help') }}</a></li>
                        <li><a href="http://www.usedata.info/resources/">{{ _('Resources') }}</a></li>
                        <li><a href="http://www.usedata.info/">{{ _('About USEDATA') }}</a></li>
                        <li><a href="http://www.usedata.info/contact/">{{ _('Contact') }}</a></li>
                        <li><a href="http://www.usedata.info/terms-of-use-2/">{{ _('Terms of use') }}</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-lg-3">
                    <ul class="list-inline list-social-buttons">
                        <li><a class="btn-animated" href="#"><img src="/img/facebook-circle-color.svg" width="50"
                                                                  height="50"
                                                                  alt="Share on Facebook"></a></li>
                        <!--
                        <li><a class="btn-animated" href="#"><img src="/img/instagram-circle-color.svg" width="50"
                                                                  height="50" alt="Share on Instagram"></a></li>
                        -->
                        <li><a class="btn-animated" href="#"><img src="/img/twitter-circle-color.svg" width="50"
                                                                  height="50"
                                                                  alt="Tweet"></a></li>
                        <!--
                        <li><a class="btn-animated" href="#"><img src="/img/linkedin-circle-color.svg" width="50"
                                                                  height="50"
                                                                  alt="Share on LinkedIn"></a></li>
                        -->
                    </ul>
                </div>
                <div class="col-md-8 col-lg-5">
                    <ul class="list-inline list-footer-logos">
                        <li><a href="#"><img src="/img/ukaid-logo-246x260.png" height="130" alt="UKAID logo"></a></li>
                        <li><a href="#"><img src="/img/montrose-logo-720x240.png" height="100" alt="Montrose logo"></a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="copyright">© {{ country.montrose_country_copyright }}</div>
        </div>
    </footer>
{% endblock %}